# deb-for-all AI Coding Agent Instructions

- Context rules: follow [.github/instructions/go.instructions.md](.github/instructions/go.instructions.md) for Go changes, [.github/instructions/python.instructions.md](.github/instructions/python.instructions.md) for Python tooling (test runner), and [.github/instructions/test_suite.instructions.md](.github/instructions/test_suite.instructions.md) for Robot suites.
- Big picture: Debian repo toolkit with library in [pkg/debian](pkg/debian) (package parsing, repo fetch, downloader, mirroring) and Cobra CLI in [cmd/deb-for-all](cmd/deb-for-all). Examples live in [examples](examples) and mirror the public API.
- Core flow: `Repository` builds URLs, fetches Release/Packages, parses into `Package` structs using shared field mappings in [pkg/debian/package.go](pkg/debian/package.go); `Downloader` in [pkg/debian/downloader.go](pkg/debian/downloader.go) handles HTTP with retries/progress/checksums; `Mirror` in [pkg/debian/mirror.go](pkg/debian/mirror.go) orchestrates suites/components/arches, writes Release/Packages files, and optionally downloads `.deb` files using pool prefix rules.
- Reuse constants: `DirPermission`, `FilePermission`, `CompressionExtensions` from [pkg/debian/package.go](pkg/debian/package.go) for all filesystem and compression handling; do not hardcode permissions or extensions.
- Parsing patterns: control and Packages files are RFC 822-like; use the existing field/dependency mappings and `parsePackageField` in [pkg/debian/repository.go](pkg/debian/repository.go) and helpers in [pkg/debian/package.go](pkg/debian/package.go) instead of ad-hoc parsing. Custom fields drop into `CustomFields`.
- Download behavior: default UA `deb-for-all/1.0`, 30s timeout, 3 retries, 2s backoff, 32KB buffer; checksum verification prefers SHA256. Concurrency defaults to 5 workers in `DownloadMultiple`.
- Mirror behavior: suites/components/arches loops generate Debian layout under `dists/` and `pool/` (lib* uses 4-char prefix, others 1-char). Release files are regenerated with checksum sections; `DownloadPackages` toggles whether `.deb` files are pulled.
- CLI shape: commands registered in [cmd/deb-for-all/root.go](cmd/deb-for-all/root.go); implementations in [cmd/deb-for-all/commands](cmd/deb-for-all/commands); i18n via go-i18n with locales in [cmd/deb-for-all/locales](cmd/deb-for-all/locales) and `DEB_FOR_ALL_LANG` env var (en/fr).
- Error/style conventions: wrap errors with `%w` and context; prefer `filepath.Join`; keep user-visible strings routed through go-i18n (TOML locales) for language selection; no unit tests by designâ€”Robot integration tests cover flows.
- Build/test workflow: `make` builds and runs Robot tests; `make build` builds locally; `make build-*-64` cross-builds; `make test` runs Robot suites (Python venv required); `make mirror-example` runs [examples/mirror/main.go](examples/mirror/main.go). Direct Robot run via `python test/start.py` after activating `.venv`.
- When adding features: extend `Package` + parser in [pkg/debian/package.go](pkg/debian/package.go) and [pkg/debian/repository.go](pkg/debian/repository.go); wire new CLI flags in [cmd/deb-for-all/main.go](cmd/deb-for-all/main.go) and commands; update both locale files for new strings; keep examples in sync.
- External deps are minimal (standard lib + `github.com/ulikunitz/xz`); avoid introducing new ones without strong reason.
- Cross-platform: Makefile already handles `.exe`; keep paths OS-agnostic and PowerShell-friendly in docs/scripts.
- Agent requirement: after any code/doc change, write a temp summary file in `%TEMP%/agent-changes-summary.txt` (or `os.TempDir()`) with a one-line title and short paragraph, and print its full path for later commit drafting ath the end of the task. If the file exists, append to it, if not create it.
- Option handling: when introducing or using CLI flags/options, ensure user-facing errors are produced for unknown or misspelled option values (e.g., dependency kinds, suites/components/architectures) and honor localization where applicable.
- Ask for clarity if requirements conflict; prefer improving existing helpers over duplicating logic.
